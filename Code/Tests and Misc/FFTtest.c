//#############################################################################
//
// FILE:        FFTtest.c
//
// Description: This example shows how to use the C2000 Real-Time CLA
//              complex FFT algorithms to perform a real FFT
//
//#############################################################################
//
//
// $Copyright: Copyright (C) 2023 Texas Instruments Incorporated -
//             http://www.ti.com/ ALL RIGHTS RESERVED $
//#############################################################################

//*****************************************************************************
// includes
//*****************************************************************************
#include "f2837x_fft_examples_setup.h"
#include <F28x_Project.h>
#include "F2837xD_device.h"
#include "rfft_1024_shared.h"
#include "device.h"
#include <float.h>
#include <stdio.h>
#include <math.h>

//!
//! \addtogroup RFFT_EXAMPLES Real Fast Fourier Transform (N = 1024) Example

// @{

//*****************************************************************************
// defines
//*****************************************************************************
#define NSTAGES         9               // 512
#define NSAMPLES        (1<<NSTAGES)
//*****************************************************************************
// globals
//*****************************************************************************
#ifdef __cplusplus
#pragma DATA_SECTION("IOBuffer")
#else
#pragma DATA_SECTION(IOBuffer,"IOBuffer")
#endif //__cplusplus
// \brief Test Input Data
//
float IOBuffer[2*NSAMPLES] = {0.00000000,   0.57580819,   0.94154407,   0.96377607,   0.63439328,   0.07356456,  -0.51410274,  -0.91420976,
                              -0.98078528,  -0.68954054,  -0.14673047,   0.44961133,   0.88192126,   0.99247953,   0.74095113,   0.21910124,
                              -0.38268343,  -0.84485357,  -0.99879546,  -0.78834643,  -0.29028468,   0.31368174,   0.80320753,   0.99969882,
                               0.83146961,   0.35989504,  -0.24298018,  -0.75720885,  -0.99518473,  -0.87008699,  -0.42755509,   0.17096189,
                               0.70710678,   0.98527764,   0.90398929,   0.49289819,  -0.09801714,  -0.65317284,  -0.97003125,  -0.93299280,
                              -0.55557023,   0.02454123,   0.59569930,   0.94952818,   0.95694034,   0.61523159,   0.04906767,  -0.53499762,
                              -0.92387953,  -0.97570213,  -0.67155895,  -0.12241068,   0.47139674,   0.89322430,   0.98917651,   0.72424708,
                               0.19509032,  -0.40524131,  -0.85772861,  -0.99729046,  -0.77301045,  -0.26671276,   0.33688985,   0.81758481,
                               1.00000000,   0.81758481,   0.33688985,  -0.26671276,  -0.77301045,  -0.99729046,  -0.85772861,  -0.40524131,
                               0.19509032,   0.72424708,   0.98917651,   0.89322430,   0.47139674,  -0.12241068,  -0.67155895,  -0.97570213,
                              -0.92387953,  -0.53499762,   0.04906767,   0.61523159,   0.95694034,   0.94952818,   0.59569930,   0.02454123,
                              -0.55557023,  -0.93299280,  -0.97003125,  -0.65317284,  -0.09801714,   0.49289819,   0.90398929,   0.98527764,
                               0.70710678,   0.17096189,  -0.42755509,  -0.87008699,  -0.99518473,  -0.75720885,  -0.24298018,   0.35989504,
                               0.83146961,   0.99969882,   0.80320753,   0.31368174,  -0.29028468,  -0.78834643,  -0.99879546,  -0.84485357,
                              -0.38268343,   0.21910124,   0.74095113,   0.99247953,   0.88192126,   0.44961133,  -0.14673047,  -0.68954054,
                              -0.98078528,  -0.91420976,  -0.51410274,   0.07356456,   0.63439328,   0.96377607,   0.94154407,   0.57580819,
                               0.00000000,  -0.57580819,  -0.94154407,  -0.96377607,  -0.63439328,  -0.07356456,   0.51410274,   0.91420976,
                               0.98078528,   0.68954054,   0.14673047,  -0.44961133,  -0.88192126,  -0.99247953,  -0.74095113,  -0.21910124,
                               0.38268343,   0.84485357,   0.99879546,   0.78834643,   0.29028468,  -0.31368174,  -0.80320753,  -0.99969882,
                              -0.83146961,  -0.35989504,   0.24298018,   0.75720885,   0.99518473,   0.87008699,   0.42755509,  -0.17096189,
                              -0.70710678,  -0.98527764,  -0.90398929,  -0.49289819,   0.09801714,   0.65317284,   0.97003125,   0.93299280,
                               0.55557023,  -0.02454123,  -0.59569930,  -0.94952818,  -0.95694034,  -0.61523159,  -0.04906767,   0.53499762,
                               0.92387953,   0.97570213,   0.67155895,   0.12241068,  -0.47139674,  -0.89322430,  -0.98917651,  -0.72424708,
                              -0.19509032,   0.40524131,   0.85772861,   0.99729046,   0.77301045,   0.26671276,  -0.33688985,  -0.81758481,
                              -1.00000000,  -0.81758481,  -0.33688985,   0.26671276,   0.77301045,   0.99729046,   0.85772861,   0.40524131,
                              -0.19509032,  -0.72424708,  -0.98917651,  -0.89322430,  -0.47139674,   0.12241068,   0.67155895,   0.97570213,
                               0.92387953,   0.53499762,  -0.04906767,  -0.61523159,  -0.95694034,  -0.94952818,  -0.59569930,  -0.02454123,
                               0.55557023,   0.93299280,   0.97003125,   0.65317284,   0.09801714,  -0.49289819,  -0.90398929,  -0.98527764,
                              -0.70710678,  -0.17096189,   0.42755509,   0.87008699,   0.99518473,   0.75720885,   0.24298018,  -0.35989504,
                              -0.83146961,  -0.99969882,  -0.80320753,  -0.31368174,   0.29028468,   0.78834643,   0.99879546,   0.84485357,
                               0.38268343,  -0.21910124,  -0.74095113,  -0.99247953,  -0.88192126,  -0.44961133,   0.14673047,   0.68954054,
                               0.98078528,   0.91420976,   0.51410274,  -0.07356456,  -0.63439328,  -0.96377607,  -0.94154407,  -0.57580819,
                              -0.00000000,   0.57580819,   0.94154407,   0.96377607,   0.63439328,   0.07356456,  -0.51410274,  -0.91420976,
                              -0.98078528,  -0.68954054,  -0.14673047,   0.44961133,   0.88192126,   0.99247953,   0.74095113,   0.21910124,
                              -0.38268343,  -0.84485357,  -0.99879546,  -0.78834643,  -0.29028468,   0.31368174,   0.80320753,   0.99969882,
                               0.83146961,   0.35989504,  -0.24298018,  -0.75720885,  -0.99518473,  -0.87008699,  -0.42755509,   0.17096189,
                               0.70710678,   0.98527764,   0.90398929,   0.49289819,  -0.09801714,  -0.65317284,  -0.97003125,  -0.93299280,
                              -0.55557023,   0.02454123,   0.59569930,   0.94952818,   0.95694034,   0.61523159,   0.04906767,  -0.53499762,
                              -0.92387953,  -0.97570213,  -0.67155895,  -0.12241068,   0.47139674,   0.89322430,   0.98917651,   0.72424708,
                               0.19509032,  -0.40524131,  -0.85772861,  -0.99729046,  -0.77301045,  -0.26671276,   0.33688985,   0.81758481,
                               1.00000000,   0.81758481,   0.33688985,  -0.26671276,  -0.77301045,  -0.99729046,  -0.85772861,  -0.40524131,
                               0.19509032,   0.72424708,   0.98917651,   0.89322430,   0.47139674,  -0.12241068,  -0.67155895,  -0.97570213,
                              -0.92387953,  -0.53499762,   0.04906767,   0.61523159,   0.95694034,   0.94952818,   0.59569930,   0.02454123,
                              -0.55557023,  -0.93299280,  -0.97003125,  -0.65317284,  -0.09801714,   0.49289819,   0.90398929,   0.98527764,
                               0.70710678,   0.17096189,  -0.42755509,  -0.87008699,  -0.99518473,  -0.75720885,  -0.24298018,   0.35989504,
                               0.83146961,   0.99969882,   0.80320753,   0.31368174,  -0.29028468,  -0.78834643,  -0.99879546,  -0.84485357,
                              -0.38268343,   0.21910124,   0.74095113,   0.99247953,   0.88192126,   0.44961133,  -0.14673047,  -0.68954054,
                              -0.98078528,  -0.91420976,  -0.51410274,   0.07356456,   0.63439328,   0.96377607,   0.94154407,   0.57580819,
                               0.00000000,  -0.57580819,  -0.94154407,  -0.96377607,  -0.63439328,  -0.07356456,   0.51410274,   0.91420976,
                               0.98078528,   0.68954054,   0.14673047,  -0.44961133,  -0.88192126,  -0.99247953,  -0.74095113,  -0.21910124,
                               0.38268343,   0.84485357,   0.99879546,   0.78834643,   0.29028468,  -0.31368174,  -0.80320753,  -0.99969882,
                              -0.83146961,  -0.35989504,   0.24298018,   0.75720885,   0.99518473,   0.87008699,   0.42755509,  -0.17096189,
                              -0.70710678,  -0.98527764,  -0.90398929,  -0.49289819,   0.09801714,   0.65317284,   0.97003125,   0.93299280,
                               0.55557023,  -0.02454123,  -0.59569930,  -0.94952818,  -0.95694034,  -0.61523159,  -0.04906767,   0.53499762,
                               0.92387953,   0.97570213,   0.67155895,   0.12241068,  -0.47139674,  -0.89322430,  -0.98917651,  -0.72424708,
                              -0.19509032,   0.40524131,   0.85772861,   0.99729046,   0.77301045,   0.26671276,  -0.33688985,  -0.81758481,
                              -1.00000000,  -0.81758481,  -0.33688985,   0.26671276,   0.77301045,   0.99729046,   0.85772861,   0.40524131,
                              -0.19509032,  -0.72424708,  -0.98917651,  -0.89322430,  -0.47139674,   0.12241068,   0.67155895,   0.97570213,
                               0.92387953,   0.53499762,  -0.04906767,  -0.61523159,  -0.95694034,  -0.94952818,  -0.59569930,  -0.02454123,
                               0.55557023,   0.93299280,   0.97003125,   0.65317284,   0.09801714,  -0.49289819,  -0.90398929,  -0.98527764,
                              -0.70710678,  -0.17096189,   0.42755509,   0.87008699,   0.99518473,   0.75720885,   0.24298018,  -0.35989504,
                              -0.83146961,  -0.99969882,  -0.80320753,  -0.31368174,   0.29028468,   0.78834643,   0.99879546,   0.84485357,
                               0.38268343,  -0.21910124,  -0.74095113,  -0.99247953,  -0.88192126,  -0.44961133,   0.14673047,   0.68954054,
                               0.98078528,   0.91420976,   0.51410274,  -0.07356456,  -0.63439328,  -0.96377607,  -0.94154407,  -0.57580819,
                              -0.00000000,   0.57580819,   0.94154407,   0.96377607,   0.63439328,   0.07356456,  -0.51410274,  -0.91420976,
                              -0.98078528,  -0.68954054,  -0.14673047,   0.44961133,   0.88192126,   0.99247953,   0.74095113,   0.21910124,
                              -0.38268343,  -0.84485357,  -0.99879546,  -0.78834643,  -0.29028468,   0.31368174,   0.80320753,   0.99969882,
                               0.83146961,   0.35989504,  -0.24298018,  -0.75720885,  -0.99518473,  -0.87008699,  -0.42755509,   0.17096189,
                               0.70710678,   0.98527764,   0.90398929,   0.49289819,  -0.09801714,  -0.65317284,  -0.97003125,  -0.93299280,
                              -0.55557023,   0.02454123,   0.59569930,   0.94952818,   0.95694034,   0.61523159,   0.04906767,  -0.53499762,
                              -0.92387953,  -0.97570213,  -0.67155895,  -0.12241068,   0.47139674,   0.89322430,   0.98917651,   0.72424708,
                               0.19509032,  -0.40524131,  -0.85772861,  -0.99729046,  -0.77301045,  -0.26671276,   0.33688985,   0.81758481,
                               1.00000000,   0.81758481,   0.33688985,  -0.26671276,  -0.77301045,  -0.99729046,  -0.85772861,  -0.40524131,
                               0.19509032,   0.72424708,   0.98917651,   0.89322430,   0.47139674,  -0.12241068,  -0.67155895,  -0.97570213,
                              -0.92387953,  -0.53499762,   0.04906767,   0.61523159,   0.95694034,   0.94952818,   0.59569930,   0.02454123,
                              -0.55557023,  -0.93299280,  -0.97003125,  -0.65317284,  -0.09801714,   0.49289819,   0.90398929,   0.98527764,
                               0.70710678,   0.17096189,  -0.42755509,  -0.87008699,  -0.99518473,  -0.75720885,  -0.24298018,   0.35989504,
                               0.83146961,   0.99969882,   0.80320753,   0.31368174,  -0.29028468,  -0.78834643,  -0.99879546,  -0.84485357,
                              -0.38268343,   0.21910124,   0.74095113,   0.99247953,   0.88192126,   0.44961133,  -0.14673047,  -0.68954054,
                              -0.98078528,  -0.91420976,  -0.51410274,   0.07356456,   0.63439328,   0.96377607,   0.94154407,   0.57580819,
                              -0.00000000,  -0.57580819,  -0.94154407,  -0.96377607,  -0.63439328,  -0.07356456,   0.51410274,   0.91420976,
                               0.98078528,   0.68954054,   0.14673047,  -0.44961133,  -0.88192126,  -0.99247953,  -0.74095113,  -0.21910124,
                               0.38268343,   0.84485357,   0.99879546,   0.78834643,   0.29028468,  -0.31368174,  -0.80320753,  -0.99969882,
                              -0.83146961,  -0.35989504,   0.24298018,   0.75720885,   0.99518473,   0.87008699,   0.42755509,  -0.17096189,
                              -0.70710678,  -0.98527764,  -0.90398929,  -0.49289819,   0.09801714,   0.65317284,   0.97003125,   0.93299280,
                               0.55557023,  -0.02454123,  -0.59569930,  -0.94952818,  -0.95694034,  -0.61523159,  -0.04906767,   0.53499762,
                               0.92387953,   0.97570213,   0.67155895,   0.12241068,  -0.47139674,  -0.89322430,  -0.98917651,  -0.72424708,
                              -0.19509032,   0.40524131,   0.85772861,   0.99729046,   0.77301045,   0.26671276,  -0.33688985,  -0.81758481,
                              -1.00000000,  -0.81758481,  -0.33688985,   0.26671276,   0.77301045,   0.99729046,   0.85772861,   0.40524131,
                              -0.19509032,  -0.72424708,  -0.98917651,  -0.89322430,  -0.47139674,   0.12241068,   0.67155895,   0.97570213,
                               0.92387953,   0.53499762,  -0.04906767,  -0.61523159,  -0.95694034,  -0.94952818,  -0.59569930,  -0.02454123,
                               0.55557023,   0.93299280,   0.97003125,   0.65317284,   0.09801714,  -0.49289819,  -0.90398929,  -0.98527764,
                              -0.70710678,  -0.17096189,   0.42755509,   0.87008699,   0.99518473,   0.75720885,   0.24298018,  -0.35989504,
                              -0.83146961,  -0.99969882,  -0.80320753,  -0.31368174,   0.29028468,   0.78834643,   0.99879546,   0.84485357,
                               0.38268343,  -0.21910124,  -0.74095113,  -0.99247953,  -0.88192126,  -0.44961133,   0.14673047,   0.68954054,
                               0.98078528,   0.91420976,   0.51410274,  -0.07356456,  -0.63439328,  -0.96377607,  -0.94154407,  -0.57580819,
                              -0.00000000,   0.57580819,   0.94154407,   0.96377607,   0.63439328,   0.07356456,  -0.51410274,  -0.91420976,
                              -0.98078528,  -0.68954054,  -0.14673047,   0.44961133,   0.88192126,   0.99247953,   0.74095113,   0.21910124,
                              -0.38268343,  -0.84485357,  -0.99879546,  -0.78834643,  -0.29028468,   0.31368174,   0.80320753,   0.99969882,
                               0.83146961,   0.35989504,  -0.24298018,  -0.75720885,  -0.99518473,  -0.87008699,  -0.42755509,   0.17096189,
                               0.70710678,   0.98527764,   0.90398929,   0.49289819,  -0.09801714,  -0.65317284,  -0.97003125,  -0.93299280,
                              -0.55557023,   0.02454123,   0.59569930,   0.94952818,   0.95694034,   0.61523159,   0.04906767,  -0.53499762,
                              -0.92387953,  -0.97570213,  -0.67155895,  -0.12241068,   0.47139674,   0.89322430,   0.98917651,   0.72424708,
                               0.19509032,  -0.40524131,  -0.85772861,  -0.99729046,  -0.77301045,  -0.26671276,   0.33688985,   0.81758481,
                               1.00000000,   0.81758481,   0.33688985,  -0.26671276,  -0.77301045,  -0.99729046,  -0.85772861,  -0.40524131,
                               0.19509032,   0.72424708,   0.98917651,   0.89322430,   0.47139674,  -0.12241068,  -0.67155895,  -0.97570213,
                              -0.92387953,  -0.53499762,   0.04906767,   0.61523159,   0.95694034,   0.94952818,   0.59569930,   0.02454123,
                              -0.55557023,  -0.93299280,  -0.97003125,  -0.65317284,  -0.09801714,   0.49289819,   0.90398929,   0.98527764,
                               0.70710678,   0.17096189,  -0.42755509,  -0.87008699,  -0.99518473,  -0.75720885,  -0.24298018,   0.35989504,
                               0.83146961,   0.99969882,   0.80320753,   0.31368174,  -0.29028468,  -0.78834643,  -0.99879546,  -0.84485357,
                              -0.38268343,   0.21910124,   0.74095113,   0.99247953,   0.88192126,   0.44961133,  -0.14673047,  -0.68954054,
                              -0.98078528,  -0.91420976,  -0.51410274,   0.07356456,   0.63439328,   0.96377607,   0.94154407,   0.57580819,
                               0.00000000,  -0.57580819,  -0.94154407,  -0.96377607,  -0.63439328,  -0.07356456,   0.51410274,   0.91420976,
                               0.98078528,   0.68954054,   0.14673047,  -0.44961133,  -0.88192126,  -0.99247953,  -0.74095113,  -0.21910124,
                               0.38268343,   0.84485357,   0.99879546,   0.78834643,   0.29028468,  -0.31368174,  -0.80320753,  -0.99969882,
                              -0.83146961,  -0.35989504,   0.24298018,   0.75720885,   0.99518473,   0.87008699,   0.42755509,  -0.17096189,
                              -0.70710678,  -0.98527764,  -0.90398929,  -0.49289819,   0.09801714,   0.65317284,   0.97003125,   0.93299280,
                               0.55557023,  -0.02454123,  -0.59569930,  -0.94952818,  -0.95694034,  -0.61523159,  -0.04906767,   0.53499762,
                               0.92387953,   0.97570213,   0.67155895,   0.12241068,  -0.47139674,  -0.89322430,  -0.98917651,  -0.72424708,
                              -0.19509032,   0.40524131,   0.85772861,   0.99729046,   0.77301045,   0.26671276,  -0.33688985,  -0.81758481,
                              -1.00000000,  -0.81758481,  -0.33688985,   0.26671276,   0.77301045,   0.99729046,   0.85772861,   0.40524131,
                              -0.19509032,  -0.72424708,  -0.98917651,  -0.89322430,  -0.47139674,   0.12241068,   0.67155895,   0.97570213,
                               0.92387953,   0.53499762,  -0.04906767,  -0.61523159,  -0.95694034,  -0.94952818,  -0.59569930,  -0.02454123,
                               0.55557023,   0.93299280,   0.97003125,   0.65317284,   0.09801714,  -0.49289819,  -0.90398929,  -0.98527764,
                              -0.70710678,  -0.17096189,   0.42755509,   0.87008699,   0.99518473,   0.75720885,   0.24298018,  -0.35989504,
                              -0.83146961,  -0.99969882,  -0.80320753,  -0.31368174,   0.29028468,   0.78834643,   0.99879546,   0.84485357,
                               0.38268343,  -0.21910124,  -0.74095113,  -0.99247953,  -0.88192126,  -0.44961133,   0.14673047,   0.68954054,
                               0.98078528,   0.91420976,   0.51410274,  -0.07356456,  -0.63439328,  -0.96377607,  -0.94154407,  -0.57580819};

#ifdef __cplusplus
#pragma DATA_SECTION("IOBuffer")
#else
#pragma DATA_SECTION(IOBuffer2,"IOBuffer")
#endif //__cplusplus
// \brief Output of the unpack routine
//
float IOBuffer2[2*NSAMPLES + 2];

float FFTMag[4*NSAMPLES];
//*****************************************************************************
// Function Prototypes
//*****************************************************************************

//*****************************************************************************
// function definitions
//*****************************************************************************
//!
//! \brief main routine for the 1024-sample RFFT example
//! \return returns a 1
//!
//! This example shows how to use the cla dsp supported CFFT routines from the
//! library to perform a real FFT. The input is placed in a section IOBuffer
//! that needs to be aligned to the size of the input in words to allow the
//! bit reverse addressing in stage 1 of the FFT to work properly.
//!
uint16_t index;
uint16_t i;
uint16_t j;


int main(void)
{

    //
    // Clear out the final result buffer
    //
    for(index = 0; index < 2*NSAMPLES + 2  ; index++)
    {
        IOBuffer2[index] = 0.0;
    }

    InitSysCtrl();
//    CLA_DSP_initSystemClocks();
    CLA_DSP_initEpie();
    CLA_DSP_configClaMemory();
    CLA_DSP_initCpu1Cla1();

    EDIS; // disable Editing of control registers

    //*************************************************************************
    // Running the FFT
    //*************************************************************************
    //! \b Running \b the \b FFT
    //! The FFT is called in task 1 of the CLA. The user can either configure
    //! task 1 to respond to a peripheral trigger source or force it in
    //! software as is done in this example
    //! \code
    //*************************************************************************
    // Step 1: Force task 1
    while(1){


            asm("  IACK  #0x0001");
            asm("  RPT #3 || NOP");
            while (CLA_getTaskRunStatus(CLA1_BASE, CLA_TASK_1) == 1);



            // Magnitude Calculation
            for(i = 0; i <= (4*NSAMPLES); i++){
                FFTMag[i] = (uint16_t)abs(IOBuffer2[i]);
            }


            asm(" ESTOP0"); // forces the program to stop so that the magnitude buffer is not changed
    }

}
// End of main

//*****************************************************************************
// ISR
//*****************************************************************************

__interrupt void cla1Isr1 ()
{
    // Acknowledge the end-of-task interrupt for task 1
    Interrupt_clearACKGroup(INTERRUPT_ACK_GROUP11);
//  asm(" ESTOP0");
}


__interrupt void cla1Isr2 ()
{
    asm(" ESTOP0");

}
// @} //addtogroup

// End of file
